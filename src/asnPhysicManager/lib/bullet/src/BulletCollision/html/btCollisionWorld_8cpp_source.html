<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Bullet Continuous Collision Detection Library: btCollisionWorld.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />



</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Bullet Continuous Collision Detection Library
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">btCollisionWorld.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="btCollisionWorld_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment">Bullet Continuous Collision Detection and Physics Library</span>
<a name="l00003"></a>00003 <span class="comment">Copyright (c) 2003-2006 Erwin Coumans  http://continuousphysics.com/Bullet/</span>
<a name="l00004"></a>00004 <span class="comment"></span>
<a name="l00005"></a>00005 <span class="comment">This software is provided &#39;as-is&#39;, without any express or implied warranty.</span>
<a name="l00006"></a>00006 <span class="comment">In no event will the authors be held liable for any damages arising from the use of this software.</span>
<a name="l00007"></a>00007 <span class="comment">Permission is granted to anyone to use this software for any purpose, </span>
<a name="l00008"></a>00008 <span class="comment">including commercial applications, and to alter it and redistribute it freely, </span>
<a name="l00009"></a>00009 <span class="comment">subject to the following restrictions:</span>
<a name="l00010"></a>00010 <span class="comment"></span>
<a name="l00011"></a>00011 <span class="comment">1. The origin of this software must not be misrepresented; you must not claim that you wrote the original software. If you use this software in a product, an acknowledgment in the product documentation would be appreciated but is not required.</span>
<a name="l00012"></a>00012 <span class="comment">2. Altered source versions must be plainly marked as such, and must not be misrepresented as being the original software.</span>
<a name="l00013"></a>00013 <span class="comment">3. This notice may not be removed or altered from any source distribution.</span>
<a name="l00014"></a>00014 <span class="comment">*/</span>
<a name="l00015"></a>00015 
<a name="l00016"></a>00016 <span class="preprocessor">#include &quot;<a class="code" href="btCollisionWorld_8h.html">btCollisionWorld.h</a>&quot;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &quot;<a class="code" href="btCollisionDispatcher_8h.html">btCollisionDispatcher.h</a>&quot;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &quot;<a class="code" href="btCollisionObject_8h.html">BulletCollision/CollisionDispatch/btCollisionObject.h</a>&quot;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &quot;<a class="code" href="btCollisionShape_8h.html">BulletCollision/CollisionShapes/btCollisionShape.h</a>&quot;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;<a class="code" href="btConvexShape_8h.html">BulletCollision/CollisionShapes/btConvexShape.h</a>&quot;</span>
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 <span class="preprocessor">#include &quot;<a class="code" href="btSphereShape_8h.html">BulletCollision/CollisionShapes/btSphereShape.h</a>&quot;</span> <span class="comment">//for raycasting</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;<a class="code" href="btTriangleMeshShape_8h.html">BulletCollision/CollisionShapes/btTriangleMeshShape.h</a>&quot;</span> <span class="comment">//for raycasting</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;<a class="code" href="btRaycastCallback_8h.html">BulletCollision/NarrowPhaseCollision/btRaycastCallback.h</a>&quot;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;<a class="code" href="btCompoundShape_8h.html">BulletCollision/CollisionShapes/btCompoundShape.h</a>&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="btSubSimplexConvexCast_8h.html">BulletCollision/NarrowPhaseCollision/btSubSimplexConvexCast.h</a>&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="btGjkConvexCast_8h.html">BulletCollision/NarrowPhaseCollision/btGjkConvexCast.h</a>&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;<a class="code" href="btContinuousConvexCollision_8h.html">BulletCollision/NarrowPhaseCollision/btContinuousConvexCollision.h</a>&quot;</span>
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="btBroadphaseInterface_8h.html">BulletCollision/BroadphaseCollision/btBroadphaseInterface.h</a>&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;LinearMath/btAabbUtil2.h&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;LinearMath/btQuickprof.h&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;LinearMath/btStackAlloc.h&quot;</span>
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <span class="comment">//When the user doesn&#39;t provide dispatcher or broadphase, create basic versions (and delete them in destructor)</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="btCollisionDispatcher_8h.html">BulletCollision/CollisionDispatch/btCollisionDispatcher.h</a>&quot;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="btSimpleBroadphase_8h.html">BulletCollision/BroadphaseCollision/btSimpleBroadphase.h</a>&quot;</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 
<a name="l00040"></a><a class="code" href="classbtCollisionWorld.html#a92495dbd1d238109e7eae59472d10d4f">00040</a> <a class="code" href="classbtCollisionWorld.html#a92495dbd1d238109e7eae59472d10d4f">btCollisionWorld::btCollisionWorld</a>(<a class="code" href="classbtDispatcher.html" title="btDispatcher can be used in combination with broadphase to dispatch overlapping pairs.">btDispatcher</a>* dispatcher,<a class="code" href="classbtOverlappingPairCache.html" title="btOverlappingPairCache maintains the objects with overlapping AABB Typically managed by the Broadphas...">btOverlappingPairCache</a>* pairCache, <span class="keywordtype">int</span> stackSize)
<a name="l00041"></a>00041 :m_dispatcher1(dispatcher),
<a name="l00042"></a>00042 m_broadphasePairCache(pairCache),
<a name="l00043"></a>00043 m_ownsDispatcher(false),
<a name="l00044"></a>00044 m_ownsBroadphasePairCache(false)
<a name="l00045"></a>00045 {
<a name="l00046"></a>00046         <a class="code" href="classbtCollisionWorld.html#a9336b3b7eb3ba09039c378831af7ff6b">m_stackAlloc</a> = <span class="keyword">new</span> btStackAlloc(stackSize);
<a name="l00047"></a>00047         <a class="code" href="classbtCollisionWorld.html#a07f4c7b327bd773c557a4804bfec7445">m_dispatchInfo</a>.<a class="code" href="structbtDispatcherInfo.html#a58a9b4edec598d8fe53610328030ce88">m_stackAllocator</a> = <a class="code" href="classbtCollisionWorld.html#a9336b3b7eb3ba09039c378831af7ff6b">m_stackAlloc</a>;
<a name="l00048"></a>00048 }
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 
<a name="l00051"></a><a class="code" href="classbtCollisionWorld.html#a30efa39d825df6624af30f10357fb16e">00051</a> <a class="code" href="classbtCollisionWorld.html#a30efa39d825df6624af30f10357fb16e">btCollisionWorld::~btCollisionWorld</a>()
<a name="l00052"></a>00052 {
<a name="l00053"></a>00053         <a class="code" href="classbtCollisionWorld.html#a9336b3b7eb3ba09039c378831af7ff6b">m_stackAlloc</a>-&gt;destroy();
<a name="l00054"></a>00054         <span class="keyword">delete</span> <a class="code" href="classbtCollisionWorld.html#a9336b3b7eb3ba09039c378831af7ff6b">m_stackAlloc</a>;
<a name="l00055"></a>00055 
<a name="l00056"></a>00056         <span class="comment">//clean up remaining objects</span>
<a name="l00057"></a>00057         <span class="keywordtype">int</span> i;
<a name="l00058"></a>00058         <span class="keywordflow">for</span> (i=0;i&lt;<a class="code" href="classbtCollisionWorld.html#a56afeead1af07bd88814d9161cb86890">m_collisionObjects</a>.size();i++)
<a name="l00059"></a>00059         {
<a name="l00060"></a>00060                 btCollisionObject* collisionObject= <a class="code" href="classbtCollisionWorld.html#a56afeead1af07bd88814d9161cb86890">m_collisionObjects</a>[i];
<a name="l00061"></a>00061                 
<a name="l00062"></a>00062                 <a class="code" href="structbtBroadphaseProxy.html" title="btBroadphaseProxy">btBroadphaseProxy</a>* bp = collisionObject-&gt;getBroadphaseHandle();
<a name="l00063"></a>00063                 <span class="keywordflow">if</span> (bp)
<a name="l00064"></a>00064                 {
<a name="l00065"></a>00065                         <span class="comment">//</span>
<a name="l00066"></a>00066                         <span class="comment">// only clear the cached algorithms</span>
<a name="l00067"></a>00067                         <span class="comment">//</span>
<a name="l00068"></a>00068                         <a class="code" href="classbtCollisionWorld.html#a6138b6b1a4496a6857f1dfa71f6841e5">getBroadphase</a>()-&gt;<a class="code" href="classbtBroadphaseInterface.html#a3987dec310fd8e673ff651f06f5ecee4">cleanProxyFromPairs</a>(bp);
<a name="l00069"></a>00069                         <a class="code" href="classbtCollisionWorld.html#a6138b6b1a4496a6857f1dfa71f6841e5">getBroadphase</a>()-&gt;<a class="code" href="classbtBroadphaseInterface.html#a289612c39d08243d2961ab46318d30be">destroyProxy</a>(bp);
<a name="l00070"></a>00070                 }
<a name="l00071"></a>00071         }
<a name="l00072"></a>00072 
<a name="l00073"></a>00073         <span class="keywordflow">if</span> (<a class="code" href="classbtCollisionWorld.html#a1e9a705bdd927c230e68fa154eec8601">m_ownsDispatcher</a>)
<a name="l00074"></a>00074                 <span class="keyword">delete</span> <a class="code" href="classbtCollisionWorld.html#aa6f6b4ae48398f89cda55492b7b55631">m_dispatcher1</a>;
<a name="l00075"></a>00075         <span class="keywordflow">if</span> (<a class="code" href="classbtCollisionWorld.html#a86efe340e0542b2e590729b163b02d31">m_ownsBroadphasePairCache</a>)
<a name="l00076"></a>00076                 <span class="keyword">delete</span> <a class="code" href="classbtCollisionWorld.html#a4f5f4f4ab95b4be5eba0911b9ba13c16">m_broadphasePairCache</a>;
<a name="l00077"></a>00077 
<a name="l00078"></a>00078 }
<a name="l00079"></a>00079 
<a name="l00080"></a>00080 
<a name="l00081"></a>00081 
<a name="l00082"></a>00082 
<a name="l00083"></a>00083 
<a name="l00084"></a>00084 
<a name="l00085"></a>00085 
<a name="l00086"></a>00086 
<a name="l00087"></a>00087 
<a name="l00088"></a>00088 
<a name="l00089"></a><a class="code" href="classbtCollisionWorld.html#ac48e8df96e3918a825f6570f243eeecd">00089</a> <span class="keywordtype">void</span>    <a class="code" href="classbtCollisionWorld.html#ac48e8df96e3918a825f6570f243eeecd">btCollisionWorld::addCollisionObject</a>(btCollisionObject* collisionObject,<span class="keywordtype">short</span> <span class="keywordtype">int</span> collisionFilterGroup,<span class="keywordtype">short</span> <span class="keywordtype">int</span> collisionFilterMask)
<a name="l00090"></a>00090 {
<a name="l00091"></a>00091 
<a name="l00092"></a>00092         <span class="comment">//check that the object isn&#39;t already added</span>
<a name="l00093"></a>00093                 btAssert( <a class="code" href="classbtCollisionWorld.html#a56afeead1af07bd88814d9161cb86890">m_collisionObjects</a>.findLinearSearch(collisionObject)  == <a class="code" href="classbtCollisionWorld.html#a56afeead1af07bd88814d9161cb86890">m_collisionObjects</a>.size());
<a name="l00094"></a>00094 
<a name="l00095"></a>00095                 <a class="code" href="classbtCollisionWorld.html#a56afeead1af07bd88814d9161cb86890">m_collisionObjects</a>.push_back(collisionObject);
<a name="l00096"></a>00096 
<a name="l00097"></a>00097                 <span class="comment">//calculate new AABB</span>
<a name="l00098"></a>00098                 btTransform trans = collisionObject-&gt;getWorldTransform();
<a name="l00099"></a>00099 
<a name="l00100"></a>00100                 btVector3       minAabb;
<a name="l00101"></a>00101                 btVector3       maxAabb;
<a name="l00102"></a>00102                 collisionObject-&gt;getCollisionShape()-&gt;getAabb(trans,minAabb,maxAabb);
<a name="l00103"></a>00103 
<a name="l00104"></a>00104                 <span class="keywordtype">int</span> type = collisionObject-&gt;getCollisionShape()-&gt;getShapeType();
<a name="l00105"></a>00105                 collisionObject-&gt;setBroadphaseHandle( <a class="code" href="classbtCollisionWorld.html#a6138b6b1a4496a6857f1dfa71f6841e5">getBroadphase</a>()-&gt;createProxy(
<a name="l00106"></a>00106                         minAabb,
<a name="l00107"></a>00107                         maxAabb,
<a name="l00108"></a>00108                         type,
<a name="l00109"></a>00109                         collisionObject,
<a name="l00110"></a>00110                         collisionFilterGroup,
<a name="l00111"></a>00111                         collisionFilterMask
<a name="l00112"></a>00112                         ))      ;
<a name="l00113"></a>00113 
<a name="l00114"></a>00114                 
<a name="l00115"></a>00115 
<a name="l00116"></a>00116 
<a name="l00117"></a>00117 
<a name="l00118"></a>00118 }
<a name="l00119"></a>00119 
<a name="l00120"></a>00120 
<a name="l00121"></a>00121 
<a name="l00122"></a>00122 
<a name="l00123"></a><a class="code" href="classbtCollisionWorld.html#a7bc2967b5005449b27f55545f224efcd">00123</a> <span class="keywordtype">void</span>    <a class="code" href="classbtCollisionWorld.html#a7bc2967b5005449b27f55545f224efcd">btCollisionWorld::performDiscreteCollisionDetection</a>()
<a name="l00124"></a>00124 {
<a name="l00125"></a>00125         <a class="code" href="structbtDispatcherInfo.html">btDispatcherInfo</a>&amp; dispatchInfo = <a class="code" href="classbtCollisionWorld.html#aa6e0fa2c310419c6539a84df107a2ac0">getDispatchInfo</a>();
<a name="l00126"></a>00126 
<a name="l00127"></a>00127         BEGIN_PROFILE(<span class="stringliteral">&quot;perform Broadphase Collision Detection&quot;</span>);
<a name="l00128"></a>00128 
<a name="l00129"></a>00129 
<a name="l00130"></a>00130         <span class="comment">//update aabb (of all moved objects)</span>
<a name="l00131"></a>00131 
<a name="l00132"></a>00132         btVector3 aabbMin,aabbMax;
<a name="l00133"></a>00133         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0;i&lt;<a class="code" href="classbtCollisionWorld.html#a56afeead1af07bd88814d9161cb86890">m_collisionObjects</a>.size();i++)
<a name="l00134"></a>00134         {
<a name="l00135"></a>00135                 <a class="code" href="classbtCollisionWorld.html#a56afeead1af07bd88814d9161cb86890">m_collisionObjects</a>[i]-&gt;getCollisionShape()-&gt;getAabb(<a class="code" href="classbtCollisionWorld.html#a56afeead1af07bd88814d9161cb86890">m_collisionObjects</a>[i]-&gt;getWorldTransform(),aabbMin,aabbMax);
<a name="l00136"></a>00136                 <a class="code" href="classbtCollisionWorld.html#a4f5f4f4ab95b4be5eba0911b9ba13c16">m_broadphasePairCache</a>-&gt;<a class="code" href="classbtBroadphaseInterface.html#ad4f9080c7cd3dd9f6bff1119cb592286">setAabb</a>(<a class="code" href="classbtCollisionWorld.html#a56afeead1af07bd88814d9161cb86890">m_collisionObjects</a>[i]-&gt;getBroadphaseHandle(),aabbMin,aabbMax);
<a name="l00137"></a>00137         }
<a name="l00138"></a>00138 
<a name="l00139"></a>00139         <a class="code" href="classbtCollisionWorld.html#a4f5f4f4ab95b4be5eba0911b9ba13c16">m_broadphasePairCache</a>-&gt;<a class="code" href="classbtOverlappingPairCache.html#a1bc58d8901f2b4b3799b572ff13536b9">refreshOverlappingPairs</a>();
<a name="l00140"></a>00140 
<a name="l00141"></a>00141         
<a name="l00142"></a>00142         END_PROFILE(<span class="stringliteral">&quot;perform Broadphase Collision Detection&quot;</span>);
<a name="l00143"></a>00143 
<a name="l00144"></a>00144         BEGIN_PROFILE(<span class="stringliteral">&quot;performDiscreteCollisionDetection&quot;</span>);
<a name="l00145"></a>00145 
<a name="l00146"></a>00146         <a class="code" href="classbtDispatcher.html" title="btDispatcher can be used in combination with broadphase to dispatch overlapping pairs.">btDispatcher</a>* dispatcher = <a class="code" href="classbtCollisionWorld.html#a65b5cb3b0070b3aca14cb4c2aff25ed5">getDispatcher</a>();
<a name="l00147"></a>00147         <span class="keywordflow">if</span> (dispatcher)
<a name="l00148"></a>00148                 dispatcher-&gt;<a class="code" href="classbtDispatcher.html#aa7842ff465b52b3bb941acc99a08b223">dispatchAllCollisionPairs</a>(<a class="code" href="classbtCollisionWorld.html#a4f5f4f4ab95b4be5eba0911b9ba13c16">m_broadphasePairCache</a>,dispatchInfo);
<a name="l00149"></a>00149 
<a name="l00150"></a>00150         END_PROFILE(<span class="stringliteral">&quot;performDiscreteCollisionDetection&quot;</span>);
<a name="l00151"></a>00151 
<a name="l00152"></a>00152 }
<a name="l00153"></a>00153 
<a name="l00154"></a>00154 
<a name="l00155"></a><a class="code" href="classbtCollisionWorld.html#a4e995146fe0b4ba6ea0024c1ea0380c3">00155</a> <span class="keywordtype">void</span>    <a class="code" href="classbtCollisionWorld.html#a4e995146fe0b4ba6ea0024c1ea0380c3">btCollisionWorld::removeCollisionObject</a>(btCollisionObject* collisionObject)
<a name="l00156"></a>00156 {
<a name="l00157"></a>00157         
<a name="l00158"></a>00158         
<a name="l00159"></a>00159         <span class="comment">//bool removeFromBroadphase = false;</span>
<a name="l00160"></a>00160         
<a name="l00161"></a>00161         {
<a name="l00162"></a>00162                 
<a name="l00163"></a>00163                 <a class="code" href="structbtBroadphaseProxy.html" title="btBroadphaseProxy">btBroadphaseProxy</a>* bp = collisionObject-&gt;getBroadphaseHandle();
<a name="l00164"></a>00164                 <span class="keywordflow">if</span> (bp)
<a name="l00165"></a>00165                 {
<a name="l00166"></a>00166                         <span class="comment">//</span>
<a name="l00167"></a>00167                         <span class="comment">// only clear the cached algorithms</span>
<a name="l00168"></a>00168                         <span class="comment">//</span>
<a name="l00169"></a>00169                         <a class="code" href="classbtCollisionWorld.html#a6138b6b1a4496a6857f1dfa71f6841e5">getBroadphase</a>()-&gt;<a class="code" href="classbtBroadphaseInterface.html#a3987dec310fd8e673ff651f06f5ecee4">cleanProxyFromPairs</a>(bp);
<a name="l00170"></a>00170                         <a class="code" href="classbtCollisionWorld.html#a6138b6b1a4496a6857f1dfa71f6841e5">getBroadphase</a>()-&gt;<a class="code" href="classbtBroadphaseInterface.html#a289612c39d08243d2961ab46318d30be">destroyProxy</a>(bp);
<a name="l00171"></a>00171                         collisionObject-&gt;setBroadphaseHandle(0);
<a name="l00172"></a>00172                 }
<a name="l00173"></a>00173         }
<a name="l00174"></a>00174 
<a name="l00175"></a>00175 
<a name="l00176"></a>00176         <span class="comment">//swapremove</span>
<a name="l00177"></a>00177         <a class="code" href="classbtCollisionWorld.html#a56afeead1af07bd88814d9161cb86890">m_collisionObjects</a>.remove(collisionObject);
<a name="l00178"></a>00178 
<a name="l00179"></a>00179 }
<a name="l00180"></a>00180 
<a name="l00181"></a>00181 
<a name="l00182"></a>00182 
<a name="l00183"></a><a class="code" href="classbtCollisionWorld.html#aca0a0ec375a89bbe445af5c4623d4618">00183</a> <span class="keywordtype">void</span>    <a class="code" href="classbtCollisionWorld.html#aca0a0ec375a89bbe445af5c4623d4618" title="rayTestSingle performs a raycast call and calls the resultCallback.">btCollisionWorld::rayTestSingle</a>(<span class="keyword">const</span> btTransform&amp; rayFromTrans,<span class="keyword">const</span> btTransform&amp; rayToTrans,
<a name="l00184"></a>00184                                           btCollisionObject* collisionObject,
<a name="l00185"></a>00185                                           <span class="keyword">const</span> <a class="code" href="classbtCollisionShape.html" title="btCollisionShape provides interface for collision shapes that can be shared among btCollisionObjects...">btCollisionShape</a>* collisionShape,
<a name="l00186"></a>00186                                           <span class="keyword">const</span> btTransform&amp; colObjWorldTransform,
<a name="l00187"></a>00187                                           <a class="code" href="structbtCollisionWorld_1_1RayResultCallback.html" title="RayResultCallback is used to report new raycast results.">RayResultCallback</a>&amp; resultCallback,<span class="keywordtype">short</span> <span class="keywordtype">int</span> collisionFilterMask)
<a name="l00188"></a>00188 {
<a name="l00189"></a>00189         
<a name="l00190"></a>00190         btSphereShape pointShape(btScalar(0.0));
<a name="l00191"></a>00191         pointShape.setMargin(0.f);
<a name="l00192"></a>00192 
<a name="l00193"></a>00193         <a class="code" href="classbtCollisionWorld.html#a542de7cc63e5fdc57efc938ca140c022" title="objectQuerySingle performs a collision detection query and calls the resultCallback. It is used internally by rayTest.">objectQuerySingle</a>(&amp;pointShape,rayFromTrans,rayToTrans,
<a name="l00194"></a>00194                                           collisionObject,
<a name="l00195"></a>00195                                           collisionShape,
<a name="l00196"></a>00196                                           colObjWorldTransform,
<a name="l00197"></a>00197                                           resultCallback,collisionFilterMask);
<a name="l00198"></a>00198 }
<a name="l00199"></a>00199 
<a name="l00200"></a><a class="code" href="classbtCollisionWorld.html#a542de7cc63e5fdc57efc938ca140c022">00200</a> <span class="keywordtype">void</span>    <a class="code" href="classbtCollisionWorld.html#a542de7cc63e5fdc57efc938ca140c022" title="objectQuerySingle performs a collision detection query and calls the resultCallback. It is used internally by rayTest.">btCollisionWorld::objectQuerySingle</a>(<span class="keyword">const</span> btConvexShape* castShape,<span class="keyword">const</span> btTransform&amp; rayFromTrans,<span class="keyword">const</span> btTransform&amp; rayToTrans,
<a name="l00201"></a>00201                                           btCollisionObject* collisionObject,
<a name="l00202"></a>00202                                           <span class="keyword">const</span> <a class="code" href="classbtCollisionShape.html" title="btCollisionShape provides interface for collision shapes that can be shared among btCollisionObjects...">btCollisionShape</a>* collisionShape,
<a name="l00203"></a>00203                                           <span class="keyword">const</span> btTransform&amp; colObjWorldTransform,
<a name="l00204"></a>00204                                           <a class="code" href="structbtCollisionWorld_1_1RayResultCallback.html" title="RayResultCallback is used to report new raycast results.">RayResultCallback</a>&amp; resultCallback,<span class="keywordtype">short</span> <span class="keywordtype">int</span> collisionFilterMask)
<a name="l00205"></a>00205 {
<a name="l00206"></a>00206         
<a name="l00207"></a>00207 
<a name="l00208"></a>00208         <span class="keywordflow">if</span> (collisionShape-&gt;<a class="code" href="classbtCollisionShape.html#acc5a62594eb897995d13cd106d9e8815">isConvex</a>())
<a name="l00209"></a>00209                         {
<a name="l00210"></a>00210                                 <a class="code" href="structbtConvexCast_1_1CastResult.html" title="RayResult stores the closest result alternatively, add a callback method to decide about closest/all ...">btConvexCast::CastResult</a> castResult;
<a name="l00211"></a>00211                                 castResult.<a class="code" href="structbtConvexCast_1_1CastResult.html#a4685e4b6ea1dd8acc76738986555874a">m_fraction</a> = btScalar(1.);<span class="comment">//??</span>
<a name="l00212"></a>00212 
<a name="l00213"></a>00213                                 btConvexShape* convexShape = (btConvexShape*) collisionShape;
<a name="l00214"></a>00214                                 <a class="code" href="classbtVoronoiSimplexSolver.html" title="btVoronoiSimplexSolver is an implementation of the closest point distance algorithm from a 1-4 points...">btVoronoiSimplexSolver</a>  simplexSolver;
<a name="l00215"></a>00215                                 <a class="code" href="classbtSubsimplexConvexCast.html" title="btSubsimplexConvexCast implements Gino van den Bergens&#39; paper &quot;Ray Casting against bteral Convex Obje...">btSubsimplexConvexCast</a> convexCaster(castShape,convexShape,&amp;simplexSolver);
<a name="l00216"></a>00216                                 <span class="comment">//btGjkConvexCast       convexCaster(castShape,convexShape,&amp;simplexSolver);</span>
<a name="l00217"></a>00217                                 <span class="comment">//btContinuousConvexCollision convexCaster(castShape,convexShape,&amp;simplexSolver,0);</span>
<a name="l00218"></a>00218                                 
<a name="l00219"></a>00219                                 <span class="keywordflow">if</span> (convexCaster.<a class="code" href="classbtSubsimplexConvexCast.html#a93202199b82c9d2f3074617f8db72e17" title="SimsimplexConvexCast calculateTimeOfImpact calculates the time of impact+normal for the linear cast (...">calcTimeOfImpact</a>(rayFromTrans,rayToTrans,colObjWorldTransform,colObjWorldTransform,castResult))
<a name="l00220"></a>00220                                 {
<a name="l00221"></a>00221                                         <span class="comment">//add hit</span>
<a name="l00222"></a>00222                                         <span class="keywordflow">if</span> (castResult.<a class="code" href="structbtConvexCast_1_1CastResult.html#a148656b35ce0209617a5f65d60260e5b">m_normal</a>.length2() &gt; btScalar(0.0001))
<a name="l00223"></a>00223                                         {
<a name="l00224"></a>00224                                                 castResult.<a class="code" href="structbtConvexCast_1_1CastResult.html#a148656b35ce0209617a5f65d60260e5b">m_normal</a>.normalize();
<a name="l00225"></a>00225                                                 <span class="keywordflow">if</span> (castResult.<a class="code" href="structbtConvexCast_1_1CastResult.html#a4685e4b6ea1dd8acc76738986555874a">m_fraction</a> &lt; resultCallback.<a class="code" href="structbtCollisionWorld_1_1RayResultCallback.html#a2218c203bbea335f75f89e8306490af0">m_closestHitFraction</a>)
<a name="l00226"></a>00226                                                 {
<a name="l00227"></a>00227 
<a name="l00228"></a>00228                                                         <a class="code" href="structbtCollisionWorld_1_1LocalRayResult.html">btCollisionWorld::LocalRayResult</a> localRayResult
<a name="l00229"></a>00229                                                                 (
<a name="l00230"></a>00230                                                                         collisionObject, 
<a name="l00231"></a>00231                                                                         0,
<a name="l00232"></a>00232                                                                         castResult.<a class="code" href="structbtConvexCast_1_1CastResult.html#a148656b35ce0209617a5f65d60260e5b">m_normal</a>,
<a name="l00233"></a>00233                                                                         castResult.<a class="code" href="structbtConvexCast_1_1CastResult.html#a4685e4b6ea1dd8acc76738986555874a">m_fraction</a>
<a name="l00234"></a>00234                                                                 );
<a name="l00235"></a>00235 
<a name="l00236"></a>00236                                                         <span class="keywordtype">bool</span> normalInWorldSpace = <span class="keyword">true</span>;
<a name="l00237"></a>00237                                                         resultCallback.<a class="code" href="structbtCollisionWorld_1_1RayResultCallback.html#a34e4e7fab2f116b924b1302ac2ce166a">AddSingleResult</a>(localRayResult, normalInWorldSpace);
<a name="l00238"></a>00238 
<a name="l00239"></a>00239                                                 }
<a name="l00240"></a>00240                                         }
<a name="l00241"></a>00241                                 }
<a name="l00242"></a>00242                         }
<a name="l00243"></a>00243                         <span class="keywordflow">else</span>
<a name="l00244"></a>00244                         {
<a name="l00245"></a>00245                                 
<a name="l00246"></a>00246                                 <span class="keywordflow">if</span> (collisionShape-&gt;<a class="code" href="classbtCollisionShape.html#a8b9c7ad626e56ba583501b8ea3bf396e">isConcave</a>())
<a name="l00247"></a>00247                                         {
<a name="l00248"></a>00248 
<a name="l00249"></a>00249                                                 <a class="code" href="classbtTriangleMeshShape.html" title="Concave triangle mesh. Uses an interface to access the triangles to allow for sharing graphics/physic...">btTriangleMeshShape</a>* triangleMesh = (<a class="code" href="classbtTriangleMeshShape.html" title="Concave triangle mesh. Uses an interface to access the triangles to allow for sharing graphics/physic...">btTriangleMeshShape</a>*)collisionShape;
<a name="l00250"></a>00250                                                 
<a name="l00251"></a>00251                                                 btTransform worldTocollisionObject = colObjWorldTransform.inverse();
<a name="l00252"></a>00252 
<a name="l00253"></a>00253                                                 btVector3 rayFromLocal = worldTocollisionObject * rayFromTrans.getOrigin();
<a name="l00254"></a>00254                                                 btVector3 rayToLocal = worldTocollisionObject * rayToTrans.getOrigin();
<a name="l00255"></a>00255 
<a name="l00256"></a>00256                                                 <span class="comment">//ConvexCast::CastResult</span>
<a name="l00257"></a>00257 
<a name="l00258"></a>00258                                                 <span class="keyword">struct </span>BridgeTriangleRaycastCallback : <span class="keyword">public</span> <a class="code" href="classbtTriangleRaycastCallback.html">btTriangleRaycastCallback</a> 
<a name="l00259"></a>00259                                                 {
<a name="l00260"></a>00260                                                         <a class="code" href="structbtCollisionWorld_1_1RayResultCallback.html" title="RayResultCallback is used to report new raycast results.">btCollisionWorld::RayResultCallback</a>* m_resultCallback;
<a name="l00261"></a>00261                                                         btCollisionObject*      m_collisionObject;
<a name="l00262"></a>00262                                                         <a class="code" href="classbtTriangleMeshShape.html" title="Concave triangle mesh. Uses an interface to access the triangles to allow for sharing graphics/physic...">btTriangleMeshShape</a>*    m_triangleMesh;
<a name="l00263"></a>00263 
<a name="l00264"></a>00264                                                         BridgeTriangleRaycastCallback( <span class="keyword">const</span> btVector3&amp; from,<span class="keyword">const</span> btVector3&amp; to,
<a name="l00265"></a>00265                                                                 <a class="code" href="structbtCollisionWorld_1_1RayResultCallback.html" title="RayResultCallback is used to report new raycast results.">btCollisionWorld::RayResultCallback</a>* resultCallback, btCollisionObject* collisionObject,<a class="code" href="classbtTriangleMeshShape.html" title="Concave triangle mesh. Uses an interface to access the triangles to allow for sharing graphics/physic...">btTriangleMeshShape</a>*    triangleMesh):
<a name="l00266"></a>00266                                                                 <a class="code" href="classbtTriangleRaycastCallback.html">btTriangleRaycastCallback</a>(from,to),
<a name="l00267"></a>00267                                                                         m_resultCallback(resultCallback),
<a name="l00268"></a>00268                                                                         m_collisionObject(collisionObject),
<a name="l00269"></a>00269                                                                         m_triangleMesh(triangleMesh)
<a name="l00270"></a>00270                                                                 {
<a name="l00271"></a>00271                                                                 }
<a name="l00272"></a>00272 
<a name="l00273"></a>00273 
<a name="l00274"></a>00274                                                         <span class="keyword">virtual</span> btScalar reportHit(<span class="keyword">const</span> btVector3&amp; hitNormalLocal, btScalar hitFraction, <span class="keywordtype">int</span> partId, <span class="keywordtype">int</span> triangleIndex )
<a name="l00275"></a>00275                                                         {
<a name="l00276"></a>00276                                                                 <a class="code" href="structbtCollisionWorld_1_1LocalShapeInfo.html" title="LocalShapeInfo gives extra information for complex shapes Currently, only btTriangleMeshShape is avai...">btCollisionWorld::LocalShapeInfo</a>        shapeInfo;
<a name="l00277"></a>00277                                                                 shapeInfo.<a class="code" href="structbtCollisionWorld_1_1LocalShapeInfo.html#a3390c8534d107c52651b93180d6284d9">m_shapePart</a> = partId;
<a name="l00278"></a>00278                                                                 shapeInfo.<a class="code" href="structbtCollisionWorld_1_1LocalShapeInfo.html#a2099265fc930533423ee8ef1af10d09e">m_triangleIndex</a> = triangleIndex;
<a name="l00279"></a>00279                                                                 
<a name="l00280"></a>00280                                                                 <a class="code" href="structbtCollisionWorld_1_1LocalRayResult.html">btCollisionWorld::LocalRayResult</a> rayResult
<a name="l00281"></a>00281                                                                 (m_collisionObject, 
<a name="l00282"></a>00282                                                                         &amp;shapeInfo,
<a name="l00283"></a>00283                                                                         hitNormalLocal,
<a name="l00284"></a>00284                                                                         hitFraction);
<a name="l00285"></a>00285                                                                 
<a name="l00286"></a>00286                                                                 <span class="keywordtype">bool</span>    normalInWorldSpace = <span class="keyword">false</span>;
<a name="l00287"></a>00287                                                                 <span class="keywordflow">return</span> m_resultCallback-&gt;AddSingleResult(rayResult,normalInWorldSpace);
<a name="l00288"></a>00288                                                                 
<a name="l00289"></a>00289                                                                 
<a name="l00290"></a>00290                                                         }
<a name="l00291"></a>00291         
<a name="l00292"></a>00292                                                 };
<a name="l00293"></a>00293 
<a name="l00294"></a>00294 
<a name="l00295"></a>00295                                                 BridgeTriangleRaycastCallback   rcb(rayFromLocal,rayToLocal,&amp;resultCallback,collisionObject,triangleMesh);
<a name="l00296"></a>00296                                                 rcb.m_hitFraction = resultCallback.<a class="code" href="structbtCollisionWorld_1_1RayResultCallback.html#a2218c203bbea335f75f89e8306490af0">m_closestHitFraction</a>;
<a name="l00297"></a>00297 
<a name="l00298"></a>00298                                                 btVector3 rayAabbMinLocal = rayFromLocal;
<a name="l00299"></a>00299                                                 rayAabbMinLocal.setMin(rayToLocal);
<a name="l00300"></a>00300                                                 btVector3 rayAabbMaxLocal = rayFromLocal;
<a name="l00301"></a>00301                                                 rayAabbMaxLocal.setMax(rayToLocal);
<a name="l00302"></a>00302 
<a name="l00303"></a>00303                                                 triangleMesh-&gt;<a class="code" href="classbtTriangleMeshShape.html#a55679e94607cda499a457865cc18c81a">processAllTriangles</a>(&amp;rcb,rayAabbMinLocal,rayAabbMaxLocal);
<a name="l00304"></a>00304                                                                                         
<a name="l00305"></a>00305                                         } <span class="keywordflow">else</span>
<a name="l00306"></a>00306                                         {
<a name="l00307"></a>00307                                                 <span class="comment">//todo: use AABB tree or other BVH acceleration structure!</span>
<a name="l00308"></a>00308                                                 <span class="keywordflow">if</span> (collisionShape-&gt;<a class="code" href="classbtCollisionShape.html#a30fac339832217881c6355ef996534bc">isCompound</a>())
<a name="l00309"></a>00309                                                 {
<a name="l00310"></a>00310                                                         <span class="keyword">const</span> <a class="code" href="classbtCompoundShape.html" title="btCompoundShape allows to store multiple other btCollisionShapes This allows for concave collision ob...">btCompoundShape</a>* compoundShape = <span class="keyword">static_cast&lt;</span><span class="keyword">const </span><a class="code" href="classbtCompoundShape.html" title="btCompoundShape allows to store multiple other btCollisionShapes This allows for concave collision ob...">btCompoundShape</a>*<span class="keyword">&gt;</span>(collisionShape);
<a name="l00311"></a>00311                                                         <span class="keywordtype">int</span> i=0;
<a name="l00312"></a>00312                                                         <span class="keywordflow">for</span> (i=0;i&lt;compoundShape-&gt;<a class="code" href="classbtCompoundShape.html#a8296822255b5862f2f730243d377566f">getNumChildShapes</a>();i++)
<a name="l00313"></a>00313                                                         {
<a name="l00314"></a>00314                                                                 btTransform childTrans = compoundShape-&gt;<a class="code" href="classbtCompoundShape.html#a93fbfe3a96ddd32e705876a2cce1ad7f">getChildTransform</a>(i);
<a name="l00315"></a>00315                                                                 <span class="keyword">const</span> <a class="code" href="classbtCollisionShape.html" title="btCollisionShape provides interface for collision shapes that can be shared among btCollisionObjects...">btCollisionShape</a>* childCollisionShape = compoundShape-&gt;<a class="code" href="classbtCompoundShape.html#abdeffd8318b45e13d9de4dc5dd7cf722">getChildShape</a>(i);
<a name="l00316"></a>00316                                                                 btTransform childWorldTrans = colObjWorldTransform * childTrans;
<a name="l00317"></a>00317                                                                 <a class="code" href="classbtCollisionWorld.html#a542de7cc63e5fdc57efc938ca140c022" title="objectQuerySingle performs a collision detection query and calls the resultCallback. It is used internally by rayTest.">objectQuerySingle</a>(castShape, rayFromTrans,rayToTrans,
<a name="l00318"></a>00318                                                                         collisionObject,
<a name="l00319"></a>00319                                                                         childCollisionShape,
<a name="l00320"></a>00320                                                                         childWorldTrans,
<a name="l00321"></a>00321                                                                         resultCallback, collisionFilterMask);
<a name="l00322"></a>00322 
<a name="l00323"></a>00323                                                         }
<a name="l00324"></a>00324 
<a name="l00325"></a>00325 
<a name="l00326"></a>00326                                                 }
<a name="l00327"></a>00327                                         }
<a name="l00328"></a>00328                         }
<a name="l00329"></a>00329 }
<a name="l00330"></a>00330 
<a name="l00331"></a><a class="code" href="classbtCollisionWorld.html#a690674a1a252868fdaf60e4aae1cd263">00331</a> <span class="keywordtype">void</span>    <a class="code" href="classbtCollisionWorld.html#a690674a1a252868fdaf60e4aae1cd263" title="rayTest performs a raycast on all objects in the btCollisionWorld, and calls the resultCallback This ...">btCollisionWorld::rayTest</a>(<span class="keyword">const</span> btVector3&amp; rayFromWorld, <span class="keyword">const</span> btVector3&amp; rayToWorld, <a class="code" href="structbtCollisionWorld_1_1RayResultCallback.html" title="RayResultCallback is used to report new raycast results.">RayResultCallback</a>&amp; resultCallback,<span class="keywordtype">short</span> <span class="keywordtype">int</span> collisionFilterMask)
<a name="l00332"></a>00332 {
<a name="l00333"></a>00333 
<a name="l00334"></a>00334         
<a name="l00335"></a>00335         btTransform     rayFromTrans,rayToTrans;
<a name="l00336"></a>00336         rayFromTrans.setIdentity();
<a name="l00337"></a>00337         rayFromTrans.setOrigin(rayFromWorld);
<a name="l00338"></a>00338         rayToTrans.setIdentity();
<a name="l00339"></a>00339         
<a name="l00340"></a>00340         rayToTrans.setOrigin(rayToWorld);
<a name="l00341"></a>00341 
<a name="l00343"></a>00343         
<a name="l00344"></a>00344         <span class="keywordtype">int</span> i;
<a name="l00345"></a>00345         <span class="keywordflow">for</span> (i=0;i&lt;<a class="code" href="classbtCollisionWorld.html#a56afeead1af07bd88814d9161cb86890">m_collisionObjects</a>.size();i++)
<a name="l00346"></a>00346         {
<a name="l00347"></a>00347                 btCollisionObject*      collisionObject= <a class="code" href="classbtCollisionWorld.html#a56afeead1af07bd88814d9161cb86890">m_collisionObjects</a>[i];
<a name="l00348"></a>00348                 <span class="comment">//only perform raycast if filterMask matches</span>
<a name="l00349"></a>00349                 <span class="keywordflow">if</span>(collisionObject-&gt;getBroadphaseHandle()-&gt;m_collisionFilterGroup &amp; collisionFilterMask) { 
<a name="l00350"></a>00350                         <span class="comment">//RigidcollisionObject* collisionObject = ctrl-&gt;GetRigidcollisionObject();</span>
<a name="l00351"></a>00351                         btVector3 collisionObjectAabbMin,collisionObjectAabbMax;
<a name="l00352"></a>00352                         collisionObject-&gt;getCollisionShape()-&gt;getAabb(collisionObject-&gt;getWorldTransform(),collisionObjectAabbMin,collisionObjectAabbMax);
<a name="l00353"></a>00353 
<a name="l00354"></a>00354                         btScalar hitLambda = btScalar(1.); <span class="comment">//could use resultCallback.m_closestHitFraction, but needs testing</span>
<a name="l00355"></a>00355                         btVector3 hitNormal;
<a name="l00356"></a>00356                         <span class="keywordflow">if</span> (btRayAabb(rayFromWorld,rayToWorld,collisionObjectAabbMin,collisionObjectAabbMax,hitLambda,hitNormal))
<a name="l00357"></a>00357                         {
<a name="l00358"></a>00358                                 <a class="code" href="classbtCollisionWorld.html#aca0a0ec375a89bbe445af5c4623d4618" title="rayTestSingle performs a raycast call and calls the resultCallback.">rayTestSingle</a>(rayFromTrans,rayToTrans,
<a name="l00359"></a>00359                                         collisionObject,
<a name="l00360"></a>00360                                                 collisionObject-&gt;getCollisionShape(),
<a name="l00361"></a>00361                                                 collisionObject-&gt;getWorldTransform(),
<a name="l00362"></a>00362                                                 resultCallback);
<a name="l00363"></a>00363                         }       
<a name="l00364"></a>00364                 }
<a name="l00365"></a>00365         }
<a name="l00366"></a>00366 
<a name="l00367"></a>00367 }
</pre></div></div><!-- contents -->


<hr class="footer"/><address class="footer"><small>
Generated on Fri Feb 17 2012 15:24:05 for Bullet Continuous Collision Detection Library by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
